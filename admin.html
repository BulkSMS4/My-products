<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — ZeroPay Store</title>
<style>
  body, html{margin:0;padding:0;font-family:Arial,sans-serif;height:100%;background:#e5ddd5;}
  body{display:flex;flex-direction:column;}

  /* Login modal */
  #loginModal {
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:999;
  }
  #loginModal div {
    background:#fff;padding:30px;border-radius:12px;width:320px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.3);
  }
  #loginModal input {width:100%;padding:10px;margin:12px 0;border-radius:6px;border:1px solid #ccc;font-size:16px;}
  #loginModal button {padding:10px 16px;border:none;border-radius:6px;background:#25D366;color:#fff;font-weight:bold;font-size:16px;cursor:pointer;}
  #loginModal button:hover{opacity:.9;}
  #loginModal p{margin-top:6px;font-size:13px;color:#555;}

  /* WhatsApp-style dashboard */
  #dashboard { display:flex; flex:1; height:100vh; }
  #sidebar { width:260px; background:#075E54; color:#fff; display:flex; flex-direction:column; padding:15px; box-shadow:2px 0 8px rgba(0,0,0,0.1);}
  #sidebar h2 { margin:10px 0;font-size:20px;color:#fff;font-weight:600; }
  #sidebar button { margin:6px 0;padding:10px 12px;background:#128C7E;border:none;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;transition:0.2s; text-align:left;}
  #sidebar button:hover{background:#25D366;}
  #sidebar button.logout{margin-top:auto;background:#c0392b;}
  #sidebar button.logout:hover{background:#e74c3c;}

  #main { flex:1; padding:20px; overflow-y:auto; background:#ece5dd; }

  /* Products list */
  .product-item{padding:12px;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;background:#fff;border-radius:8px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);}
  .small{font-size:13px;color:#555;}
  button{padding:6px 10px;border:none;border-radius:6px;background:#128C7E;color:#fff;font-weight:bold;cursor:pointer;margin:2px;transition:0.2s;}
  button:hover{opacity:.85;}

  .admin-carousel img { width:90px; height:70px; object-fit:cover; border-radius:6px; border:1px solid #ccc; }
  .admin-carousel button { font-size:14px; line-height:1; user-select:none; position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:#fff; border:none; border-radius:50%; padding:2px 6px; cursor:pointer; }
  .image-preview img { max-width:100px; margin-right:5px; margin-top:5px; border-radius:6px; border:1px solid #ccc; }

  input,textarea{padding:8px;border-radius:6px;border:1px solid #ccc;margin-bottom:8px;width:100%;font-size:14px;}
  textarea{resize:none;}
  h3{margin-top:10px;color:#075E54;}

  /* Popup composer section */
  #popupComposer .popup-preview { background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.08); }
  .small-muted{font-size:12px;color:#666;margin-top:6px;}
</style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal">
  <div>
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Enter Password" />
    <button id="loginBtn">Login</button>
    <p style="font-size:12px;color:#555;">Password is hidden for security.</p>
    <p id="loginError" style="color:red;font-size:13px;display:none;">Wrong password!</p>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <div id="sidebar">
    <h2>ZeroPay Admin</h2>
    <button id="showProducts">Products</button>
    <button id="addProductBtn">Add Product</button>
    <button id="showPopupsBtn">Pop-Ups</button>
    <button id="exportJson">Export JSON</button>
    <button id="resetStore">Reset Store</button>
    <button id="logoutBtn" class="logout">Logout</button>
    <div style="margin-top:12px;" class="small-muted">Tip: After sending a pop-up, export <code>popup.json</code> and upload to your site root to broadcast to all visitors.</div>
  </div>
  <div id="main">
    <!-- PRODUCTS LIST -->
    <div id="productList"></div>

    <!-- ADD PRODUCT FORM -->
    <div id="addProductForm" style="display:none;">
      <h3>Add Product</h3>
      <input id="pname" placeholder="Name" />
      <input id="pprice" placeholder="Price" type="number" step="0.01" />
      <input id="pimage" placeholder="Image URLs (comma separated)" />
      <input id="pcurrency" placeholder="Currency (GHS, USD etc)" />
      <div class="image-preview" id="imagePreview"></div>
      <textarea id="pdesc" placeholder="Description"></textarea>
      <input id="ppayment" placeholder="Payment link (optional)" />
      <button id="addProduct">Add Product</button>
    </div>

    <!-- POPUP COMPOSER -->
    <div id="popupSection" style="display:none;">
      <h3>Send Pop-Up Notification</h3>
      <div id="popupComposer">
        <textarea id="popupText" placeholder="Pop-up message (title + short text)"></textarea>
        <input id="popupImg" placeholder="Image URL (optional)" />
        <input id="popupBtnText" placeholder="Button Text (optional)" />
        <input id="popupBtnLink" placeholder="Button Link (optional)" />
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="sendPopupBtn">Send Pop-Up (save to local)</button>
          <button id="publishPopupBtn" style="background:#075E54;">Publish & Export popup.json</button>
        </div>
        <div class="small-muted">Publishing exports <code>popup.json</code>. Upload that file to your host root so all site visitors get the popup automatically (recommended).</div>
        <h4>Preview</h4>
        <div id="popupPreview" class="popup-preview">No preview yet.</div>
      </div>

      <h4 style="margin-top:18px;">Existing pop-ups (local)</h4>
      <div id="existingPopups"></div>
    </div>

  </div>
</div>

<script>
  // ==== Password protection ====
  const LOGIN_PASSWORD = 'forgetme'; 
  const loginModal = document.getElementById('loginModal');
  const dashboard = document.getElementById('dashboard');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  loginBtn.onclick = () => {
    const pass = document.getElementById('adminPassword').value;
    if(pass === LOGIN_PASSWORD){
      loginModal.style.display = 'none';
      dashboard.style.display = 'flex';
      initDashboard();
    }else{
      loginError.style.display = 'block';
    }
  };

  function initDashboard(){
    // keep your original behavior: products in localStorage or products.json
    window.products = [];
    let popups = JSON.parse(localStorage.getItem('zp_popups') || '[]');

    async function loadInitial(){
      const stored = localStorage.getItem('zp_products');
      if(stored){
        window.products = JSON.parse(stored);
      }else{
        try{ const r=await fetch('products.json'); if(r.ok) window.products = await r.json(); }catch(e){ window.products=[]; }
      }
      renderList();
      renderExistingPopups();
    }

    // RENDER PRODUCTS in original WhatsApp admin style (unchanged)
    function renderList(){
      const el = document.getElementById('productList');
      el.innerHTML = '';
      if(!window.products || window.products.length===0){ el.innerHTML='<p>No products yet.</p>'; return; }

      window.products.forEach((p,i)=>{
        const row = document.createElement('div');
        row.className='product-item';
        const imagesHtml = `<div class="admin-carousel" id="admin-carousel-${i}" style="position:relative;display:inline-block;">
          <img src="${(p.images&&p.images[0])?p.images[0]:(p.image? (Array.isArray(p.image)?p.image[0]:p.image) : 'https://via.placeholder.com/600x400?text=Product')}">
          ${(p.images && p.images.length>1)?'<button class="prev-btn">‹</button><button class="next-btn">›</button>':''}
        </div>`;
        row.innerHTML=`
          <div style="display:flex;gap:8px;align-items:center;">
            ${imagesHtml}
            <div>
              <strong>${p.name}</strong>
              <div class="small">${p.currency || 'GHS'} ${Number(p.price).toFixed(2)}</div>
              <div class="small">ID: ${p.id}</div>
            </div>
          </div>
          <div>
            <button onclick="editProduct(${i})">Edit</button>
            <button onclick="deleteProduct(${i})">Delete</button>
          </div>
        `;
        el.appendChild(row);

        // carousel logic
        if(p.images && p.images.length>1){
          const carousel = row.querySelector(`#admin-carousel-${i}`);
          const imgEl = carousel.querySelector('img');
          let imgIndex=0;
          carousel.querySelector('.prev-btn')?.addEventListener('click',()=>{ imgIndex=(imgIndex-1+p.images.length)%p.images.length; imgEl.src=p.images[imgIndex]; });
          carousel.querySelector('.next-btn')?.addEventListener('click',()=>{ imgIndex=(imgIndex+1)%p.images.length; imgEl.src=p.images[imgIndex]; });
        }
      });
    }

    function save(){ localStorage.setItem('zp_products',JSON.stringify(window.products||[])); }

    // IMAGE PREVIEW for add form
    const pimage = document.getElementById('pimage');
    pimage?.addEventListener('input',()=>{
      const preview = document.getElementById('imagePreview');
      preview.innerHTML='';
      const urls = (pimage.value || '').split(',').map(u=>u.trim()).filter(u=>u);
      urls.forEach(url=>{ const img=document.createElement('img'); img.src=url; preview.appendChild(img); });
    });

    // ADD PRODUCT (same UX)
    document.getElementById('addProduct').onclick = ()=>{
      const name = document.getElementById('pname').value.trim();
      const price = parseFloat(document.getElementById('pprice').value)||0;
      const images = (document.getElementById('pimage').value || '').split(',').map(u=>u.trim()).filter(u=>u);
      const currency = document.getElementById('pcurrency').value.trim() || 'GHS';
      const desc = document.getElementById('pdesc').value.trim();
      const payment = document.getElementById('ppayment').value.trim();
      if(!name) return alert('Name required');
      const id='p'+Date.now();
      // keep both images[] and image property for compatibility
      const prod = {id,name,price,currency,description:desc,payment_link:payment};
      if(images.length>0){ prod.images = images; prod.image = images[0]; }
      else { prod.images = []; prod.image = ''; }
      window.products.push(prod);
      save();
      renderList();
      // clear
      document.getElementById('pname').value=''; document.getElementById('pprice').value=''; document.getElementById('pimage').value=''; document.getElementById('pcurrency').value=''; document.getElementById('pdesc').value=''; document.getElementById('ppayment').value=''; document.getElementById('imagePreview').innerHTML='';
      alert('Product added');
    };

    window.editProduct = function(i){
      const p = window.products[i];
      p.name = prompt('Name:',p.name)||p.name;
      p.price = parseFloat(prompt('Price:',p.price))||p.price;
      const imgs = prompt('Image URLs (comma separated):', (p.images && p.images.length)? p.images.join(',') : (p.image||'')) || '';
      p.images = imgs.split(',').map(x=>x.trim()).filter(x=>x);
      p.image = p.images[0] || p.image;
      p.currency = prompt('Currency:',p.currency)||p.currency;
      p.description = prompt('Description:',p.description)||p.description;
      p.payment_link = prompt('Payment Link:',p.payment_link||'')||p.payment_link;
      save(); renderList();
    };

    window.deleteProduct = function(i){ if(confirm('Delete this product?')){ window.products.splice(i,1); save(); renderList(); } };

    // Sidebar buttons - preserve UX
    document.getElementById('showProducts').onclick = ()=>{ document.getElementById('addProductForm').style.display='none'; document.getElementById('popupSection').style.display='none'; renderList(); };
    document.getElementById('addProductBtn').onclick = ()=>{ document.getElementById('popupSection').style.display='none'; document.getElementById('addProductForm').style.display='block'; };
    document.getElementById('showPopupsBtn').onclick = ()=>{ document.getElementById('addProductForm').style.display='none'; document.getElementById('popupSection').style.display='block'; renderExistingPopups(); };

    // Export products.json
    document.getElementById('exportJson').onclick = ()=>{ const data=JSON.stringify(window.products||[],null,2); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='products.json'; a.click(); };

    // Reset store from hosted products.json
    document.getElementById('resetStore').onclick = async ()=>{ if(!confirm("Reset store to default products.json?")) return; try{ const r=await fetch("products.json"); if(!r.ok) throw new Error('no file'); window.products=await r.json(); save(); renderList(); }catch(e){ alert("Cannot reset: products.json missing."); } };

    // Logout
    document.getElementById('logoutBtn').onclick = ()=>{ localStorage.removeItem('zp_products'); location.reload(); };

    // ------------------ POPUP COMPOSER ------------------
    function renderExistingPopups(){
      const list = document.getElementById('existingPopups');
      list.innerHTML = '';
      popups = JSON.parse(localStorage.getItem('zp_popups') || '[]');
      if(popups.length===0){ list.innerHTML = '<p>No pop-ups.</p>'; return; }
      popups.forEach((pp,i)=>{
        const d = document.createElement('div');
        d.style.padding='8px'; d.style.border='1px solid #ddd'; d.style.marginBottom='8px'; d.style.borderRadius='6px'; d.innerHTML = `<b>${pp.text}</b><div class="small">${pp.created}</div><div style="margin-top:6px"><button onclick="removePopup(${i})" style="background:#c0392b">Remove</button></div>`;
        list.appendChild(d);
      });
    }

    window.removePopup = function(i){
      if(!confirm('Remove this pop-up?')) return;
      popups.splice(i,1);
      localStorage.setItem('zp_popups', JSON.stringify(popups));
      renderExistingPopups();
    };

    // Send pop-up (local storage only)
    document.getElementById('sendPopupBtn').addEventListener('click', ()=>{
      const ad = {
        text: document.getElementById('popupText').value || '',
        img: document.getElementById('popupImg').value || '',
        btnText: document.getElementById('popupBtnText').value || '',
        btnLink: document.getElementById('popupBtnLink').value || '',
        created: new Date().toISOString()
      };
      popups.push(ad);
      localStorage.setItem('zp_popups', JSON.stringify(popups));
      alert('Pop-up saved locally. Export popup.json and upload to your site root to broadcast to all visitors.');
      renderExistingPopups();
    });

    // Publish & Export popup.json (download)
    document.getElementById('publishPopupBtn').addEventListener('click', ()=>{
      const data = JSON.stringify(popups || [], null, 2);
      const blob = new Blob([data], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'popup.json';
      a.click();
      alert('popup.json downloaded. Upload it to your site root to publish pop-ups to all visitors.');
    });

    // preview update
    function updatePreview(){
      const txt = document.getElementById('popupText').value || '';
      const img = document.getElementById('popupImg').value || '';
      const btnText = document.getElementById('popupBtnText').value || '';
      let html = `<b>${txt}</b><br/>`;
      if(img) html += `<img src="${img}" width="150" style="margin-top:6px;"/><br/>`;
      if(btnText) html += `<button style="margin-top:8px;">${btnText}</button>`;
      document.getElementById('popupPreview').innerHTML = html;
    }
    document.getElementById('popupText').addEventListener('input', updatePreview);
    document.getElementById('popupImg').addEventListener('input', updatePreview);
    document.getElementById('popupBtnText').addEventListener('input', updatePreview);

    // initial load
    loadInitial();
  }
</script>
</body>
</html>
